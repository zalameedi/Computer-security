/********
 * Zeid Al-Ameedi
 * Date 03-01-2019
 * Reverse shell exploit coded in C using server to host the malware.
 * Pass in Server IP/Port # to run
 * client.c will accompany to connect to this server
*********/ 

#include<stdio.h>
#include<stdlib.h>
#include<netdb.h>
#include<sys/socket.h>

/********
struct sockaddr_in 
{
    sa_family_t sin_family //AF_INET for TCP/IP
    in_port_t sin_port //port number
    struct in_addr sin_addr; //IP Address
};
struct in_addr //internet address
{
    uint32_t s_addr //IP address in network byte order
}
*********/

struct sockaddr_in server_addr;
struct sockaddr_in client_addr; 

int main(int argc, char *argv[])
{
    int len = 0;
    int sock=0;
    int n =0;
    char line[256];

    if(argc > 2)
    {
        //Step 1: Creates socket and bind sockaddr with SERVER's IP ADDRESS and port num
    int tcpSocket = socket(AF_INET, SOCK_STREAM, 0); //domain, type, protocol
    if(tcpSocket > 0)
    {
        printf("Socket was created successfully.\n");
    }
    
    //Step 2: Fill server's socket address with host IP and port #
    server_addr.sin_family = AF_INET; //    TCP/IP
    server_addr.sin_port = argv[2]; //Sets port number
    //server_addr.sin_addr.s_addr = htonl(INADDR_ANY); //converts unsigned int to network byte
    server_addr.sin_addr.s_addr = inet_addr(argv[1]);


    //Step 3: Bind the socket to a IP address/port number
    int bd = bind(tcpSocket, (struct sockaddr*)&server_addr, sizeof(server_addr));
    if(bd > 0)
    {
        printf("Socket was successfully binded.\n");
    }

    //Step 4: Listen
    listen(tcpSocket, 5);
        while(1)
        {
            len = sizeof(client_addr);
            //Step 5: Accept
            sock = accept(tcpSocket, (struct sockaddr *)&client_addr, &len);
            if(sock > 0)
            {
                printf("Client successfully connected.\n");
            }
            while(1)
            {
                n = read(sock, line, 256);
                if(n==0)
                {
                    printf("Client died.\n");
                }
            }
        }
    }
    else 
    {
        printf("Must pass in IP address and port number.\n");
    }
}